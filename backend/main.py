from fastapi import FastAPI, UploadFile, File, HTTPException
from fastapi.responses import FileResponse
from fastapi.middleware.cors import CORSMiddleware
from fastapi.staticfiles import StaticFiles
from pydantic import BaseModel
import shutil
import os
import uuid
from typing import List, Dict, Any
from processor import VideoProcessor

app = FastAPI()

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Directories
UPLOAD_DIR = "backend/uploads"
EXPORT_DIR = "backend/exports"
FONTS_DIR = "backend/flat_fonts" 

for d in [UPLOAD_DIR, EXPORT_DIR, FONTS_DIR]:
    os.makedirs(d, exist_ok=True)

processor = VideoProcessor(FONTS_DIR)

# --- MODELS ---
class CaptionItem(BaseModel):
    id: Any
    text: str
    start_time: float
    end_time: float

# Request for Generating Captions (Transcribe + Translate)
class ProcessRequest(BaseModel):
    file_id: str
    language: str = "English" 

# Request for Burning Video (Export)
class ExportRequest(BaseModel):
    file_id: str
    captions: List[CaptionItem]
    style: Dict[str, Any] = {} 

# --- ROUTES ---

@app.post("/api/upload")
async def upload_video(file: UploadFile = File(...)):
    try:
        file_id = str(uuid.uuid4())
        file_ext = file.filename.split('.')[-1]
        file_path = os.path.join(UPLOAD_DIR, f"{file_id}.{file_ext}")

        with open(file_path, "wb") as buffer:
            shutil.copyfileobj(file.file, buffer)

        return {
            "success": True, 
            "file_id": file_id, 
            "raw_url": f"/uploads/{file_id}.{file_ext}"
        }
    except Exception as e:
        return {"success": False, "error": str(e)}

@app.post("/api/process")
async def process_video(req: ProcessRequest):
    # Runs Whisper -> GPT-4o pipeline (Text Only)
    input_path = None
    for f in os.listdir(UPLOAD_DIR):
        if f.startswith(req.file_id):
            input_path = os.path.join(UPLOAD_DIR, f)
            break

    if not input_path:
        return {"success": False, "error": "File not found"}

    return await processor.generate_captions_only(input_path, target_language=req.language)

@app.post("/api/export")
async def export_video(req: ExportRequest):
    # Burns the styles into the video
    print(f"ðŸ“¥ EXPORT REQUEST RECEIVED. Style Data: {req.style}") 

    input_path = None
    for f in os.listdir(UPLOAD_DIR):
        if f.startswith(req.file_id):
            input_path = os.path.join(UPLOAD_DIR, f)
            break

    if not input_path:
        raise HTTPException(status_code=404, detail="Original video not found")

    output_filename = f"export_{req.file_id}.mp4"
    output_path = os.path.join(EXPORT_DIR, output_filename)

    captions_data = [c.dict() for c in req.captions]

    result = await processor.burn_only(input_path, output_path, captions_data, req.style)

    if not result['success']:
        return {"success": False, "error": result.get('error')}

    return {
        "success": True,
        "video_url": f"/exports/{output_filename}"
    }

# --- FILE SERVING ---
app.mount("/uploads", StaticFiles(directory=UPLOAD_DIR), name="uploads")
app.mount("/exports", StaticFiles(directory=EXPORT_DIR), name="exports")

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)